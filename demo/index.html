<!DOCTYPE html>
<meta charset="utf-8">
<title>D3 Nesting Examples</title>

<!-- styles -->
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="../docleaves.css">

<!-- elements -->
<xmp class="container" theme="united">

# D3 Nest examples

## Asynchronous call

<script type="text/eval+javascript" placeholder="Loadingâ€¦">
return new Promise(function(resolve, reject) {
	var xhr = new XMLHttpRequest;

	xhr.onload = function() {
		$scope.data = xhr.response._items;
		resolve(xhr.response, xhr.statusText, xhr);
	};

	xhr.onerror = function() {
		reject(xhr.statusText, xhr);
	};

	xhr.open('GET', 'https://peerj.com/articles/index.json');
	xhr.responseType = 'json';

	xhr.send();
});
</script>

## Single-level nest: group by subject

<script type="text/eval+javascript">
var list = d3.nest().key(function(d)  {
	return d.subjects[0];
});

$scope.nested = list;

return list.entries($scope.data);
</script>

## Use rollup to count leaves

The leaf level is replaced by a value at the parent level

<script type="text/eval+javascript">
return $scope.nested.rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);
</script>

## Rollup does sums as well

<script type="text/eval+javascript">
return $scope.nested.rollup(function(leaves) {
	return {
		length: leaves.length,
		total_subjects: d3.sum(leaves, function(d) {
			return d.subjects.length;
		})
	}
}).entries($scope.data);
</script>

## Rollup everything to get a grand total of number of lines

<script type="text/eval+javascript">
return d3.nest().rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);
</script>

## Sorting

Each level can be sorted by key - a simple ascending or descending...

<script type="text/eval+javascript">
return $scope.nested.sortKeys(d3.ascending).rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);
</script>

## Sorting - custom order

<script type="text/eval+javascript">
var sticky = ['Paleontology', 'Ecology'];

var list = $scope.nested.sortKeys(function(a,b) {
	return sticky.indexOf(b) - sticky.indexOf(a);
}).rollup(function(leaves) {
	return leaves.length;
});

$scope.sorted = list;

return list.entries($scope.data);
</script>

## Sorting - sort the leaves by value

<script type="text/eval+javascript">
return $scope.sorted.sortValues(function(a,b) {
	return a.date > b.date ? 1 : -1;
}).entries($scope.data);
</script>

## Populate a Select list from csv data

Use nest to get a unique list of people then create a select from it.

<script type="text/eval+javascript">
var items = d3.nest().key(function(d) {
	return d.subjects[0];
}).sortKeys(d3.ascending).rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);

var output = document.createElement('div');
var select = d3.select(output).append('select');

select.selectAll('option').data(items).enter().append('option').attr('value', function(d) {
	return d.key;
}).text(function(d) {
	return d.key;
});

return output;
</script>

</xmp>

<!-- scripts -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://strapdownjs.com/v/0.2/strapdown.js"></script>
<script src="../docleaves.js"></script>
<script>
var $scope = {};
docleaves.ready();
</script>
