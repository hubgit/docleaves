<!DOCTYPE html>
<meta charset="utf-8">
<title>D3 Nesting Examples</title>

<!-- styles -->
<link rel="stylesheet" href="../docleaves.css">

<!-- scripts -->
<script>var $scope = {};</script>
<script src="d3/d3.js"></script>
<script src="../docleaves.js"></script>

<!-- elements -->
<article class="container markdown">

# D3 Nest examples

## Asynchronous call

<script type="text/eval+javascript" class="leaf auto" placeholder="Loadingâ€¦">
var request = docleaves.get('https://peerj.com/articles/index.json', 'json');

request.then(function(data) {
	$scope.data = data._items;
});

return request;
</script>

## Single-level nest: group by subject

<script type="text/eval+javascript" class="leaf auto">
var list = d3.nest().key(function(d)  {
	return d.subjects[0];
});

$scope.nested = list;

return list.entries($scope.data);
</script>

## Use rollup to count leaves

The leaf level is replaced by a value at the parent level

<script type="text/eval+javascript" class="leaf">
return $scope.nested.rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);
</script>

## Rollup does sums as well

<script type="text/eval+javascript" class="leaf">
return $scope.nested.rollup(function(leaves) {
	return {
		length: leaves.length,
		total_subjects: d3.sum(leaves, function(d) {
			return d.subjects.length;
		})
	}
}).entries($scope.data);
</script>

## Rollup everything to get a grand total of number of items

<script type="text/eval+javascript" class="leaf">
return d3.nest().rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);
</script>

## Sorting

Each level can be sorted by key - ascending or descending

<script type="text/eval+javascript" class="leaf">
return $scope.nested.sortKeys(d3.ascending).rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);
</script>

## Sorting - custom order

<script type="text/eval+javascript" class="leaf">
var sticky = ['Paleontology', 'Ecology'];

var list = $scope.nested.sortKeys(function(a,b) {
	return sticky.indexOf(b) - sticky.indexOf(a);
}).rollup(function(leaves) {
	return leaves.length;
});

$scope.sorted = list;

return list.entries($scope.data);
</script>

## Sorting - sort the leaves by value

<script type="text/eval+javascript" class="leaf">
return $scope.sorted.sortValues(function(a,b) {
	return a.date > b.date ? 1 : -1;
}).entries($scope.data);
</script>

## Populate a select list

<script type="text/eval+javascript" class="leaf auto">
var items = d3.nest().key(function(d) {
	return d.subjects[0];
}).sortKeys(d3.ascending).rollup(function(leaves) {
	return leaves.length;
}).entries($scope.data);

var output = document.createElement('div');
var select = d3.select(output).append('select');

select.selectAll('option').data(items).enter().append('option').attr('value', function(d) {
	return d.key;
}).text(function(d) {
	return d.key;
});

return output;
</script>

</article>

